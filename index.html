<html>

<head>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
</head>


<body>

<div>
<label>Name: <input type="text" id="fullname"></label>
</div>
<div>

<label>Job posting: <input type="text" id="jobsrc"></label>
</div>

<div>
<label>Codename: <input type="text" id="codename"></label>
</div>

<div>
<label>Date (YYYYMMDD): <input type="text" id="date"></label>
</div>

<div>
<input type="button" id="goButton" value="Go">
</div>

<div id="output" style="font-family: monospace">
</div>

<div id="hashToVerify" style="font-family: monospace">
</div>
 
 
<script>
  var goButton = document.getElementById("goButton");
  var fullnameField = document.getElementById("fullname");
  var jobsrcField = document.getElementById("jobsrc");
  var codenameField = document.getElementById("codename");
  var dateField = document.getElementById("date");
  var outputDiv = document.getElementById("output");
  var hashToVerifyDiv = document.getElementById("hashToVerify");
 
  var referrer = document.referrer;
  if (referrer) {
    jobsrcField.value = referrer;
  }
 
  var today = new Date();
  var dd = String(today.getDate()).padStart(2, '0');
  var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
  var yyyy = today.getFullYear();
 
  dateField.value = yyyy+mm+dd;
  
  var codename = localStorage.getItem("codename");
  if (codename) {
    codenameField.value = codename;
  }

  var fullname = localStorage.getItem("fullname");
  if (fullname) {
    fullnameField.value = fullname;
  }
 
  var params = (new URL(document.location)).searchParams;
  var hashToVerify = params.get("h");
 
  if (hashToVerify) {
   hashToVerifyDiv.innerHTML = hashToVerify;
  }
 
  goButton.addEventListener("click", () => {

    var message_str = fullnameField.value;
    var salt = "nonce goes here";

    var data = CryptoJS.PBKDF2(message_str, salt, { iterations: 10000 });

    var signature_hash_obj = CryptoJS.HmacSHA256(data, jobsrcField.value);
    var signature_str = signature_hash_obj.toString(CryptoJS.enc.Base64);

    signature_hash_obj = CryptoJS.HmacSHA256(signature_str, codenameField.value);
    signature_str = signature_hash_obj.toString(CryptoJS.enc.Base64);

    signature_hash_obj = CryptoJS.HmacSHA256(signature_str, dateField.value);
    signature_str = signature_hash_obj.toString(CryptoJS.enc.Hex);
    

    var hashOutput = signature_str.slice(0, 14);
    var rawHash = ("" + signature_hash_obj).slice(0, 7);
    var urlparams = { c: codenameField.value, d: dateField.value, h: rawHash, j: jobsrcField.value };
    var jsonUrlParams = JSON.stringify(urlparams);
    const encodedWord = CryptoJS.enc.Utf8.parse(jsonUrlParams);
    var b64UrlParams = CryptoJS.enc.Base64.stringify(encodedWord);
    
    
    var verifyUrl = "https://iansharkey.github.io/codename/p=" + b64UrlParams;
    outputDiv.innerHTML = codenameField.value + " (" + hashOutput + ", " + dateField.value + "). " + verifyUrl;
    localStorage.setItem("codename", codenameField.value);
    localStorage.setItem("fullname", fullnameField.value);
    
    if (hashToVerify) {
      var hashOutputList = [];
      var verifiedOutputList = [];
     
      for ( var i = 0; i < 14; i++) {
         if ( hashOutput[i] == hashToVerify[i] ) {
           hashOutputList.push('<span style="background-color: lightgreen">' + hashOutput[i] + '</span>');
           verifiedOutputList.push('<span style="background-color: lightgreen">' + hashToVerify[i] + '</span>');
         }
         else {
           hashOutputList.push('<span style="background-color: lightcoral">' + hashOutput[i] + '</span>');
           verifiedOutputList.push('<span style="background-color: lightcoral">' + hashToVerify[i] + '</span>');
         }
      }
      outputDiv.innerHTML = hashOutputList.join('') + ' ' + ((hashOutput == hashToVerify) ? '✅' : '❌');
      hashToVerifyDiv.innerHTML = verifiedOutputList.join('');
    }

  });

</script>

</body>
</html>
