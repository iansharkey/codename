<html>

<head>
 <script src="smaz.js"></script>
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
</head>


<body>

<div>
 <label>Name: <input type="text" id="fullname"></label>
</div>

<div>
 <label>Persona: <input type="text" id="codename"></label>
</div>


<div>
 <label>Context (job posting URL, phone number, etc.): <input type="text" id="jobsrc"></label>
</div>


<div>
<label>Date (YYYYMMDD): <input type="text" id="date"></label>
</div>

<div>
 <input type="button" id="goButton" value="Go">
</div>

<div id="output" style="font-family: monospace">
</div>


<hr />

<div>
 <a name="verify"><label>Verify: <input type="text" id="verify"></label></a>
</div>

<div>
 <label>Provided name: <input type="text" id="verifyName"></label>
</div>

<div>
 <input type="button" id="verifyButton" value="Verify">
</div>

<div id="hashToVerify" style="font-family: monospace">
</div>

<div id="hashComputed" style="font-family: monospace">
</div>


 
<script>
  var goButton = document.getElementById("goButton");
  var fullnameField = document.getElementById("fullname");
  var jobsrcField = document.getElementById("jobsrc");
  var codenameField = document.getElementById("codename");
  var dateField = document.getElementById("date");
  var outputDiv = document.getElementById("output");
  var hashToVerifyDiv = document.getElementById("hashToVerify");
  var hashComputedDiv = document.getElementById("hashComputed");
  var verifyField = document.getElementById("verify");
  var providedNameField = document.getElementById("verifyName");
  var verifyButton = document.getElementById("verifyButton");
  
 
  var referrer = document.referrer;
  if (referrer) {
    jobsrcField.value = referrer;
  }
 
  var today = new Date();
  var dd = String(today.getDate()).padStart(2, '0');
  var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
  var yyyy = today.getFullYear();
 
  dateField.value = yyyy+mm+dd;
  
  var codename = localStorage.getItem("codename");
  if (codename) {
    codenameField.value = codename;
  }

  var fullname = localStorage.getItem("fullname");
  if (fullname) {
    fullnameField.value = fullname;
  }
 
  var params = (new URL(document.location)).searchParams;
  var hashToVerify = params.get("h");
 
  if (hashToVerify) {
   hashToVerifyDiv.innerText = hashToVerify;
  }
  const byteToHex = [];

  for (let n = 0; n <= 0xff; ++n)
  {
      const hexOctet = n.toString(16).padStart(2, "0");
      byteToHex.push(hexOctet);
  }

  function hex(arrayBuffer)
  {
      const buff = new Uint8Array(arrayBuffer);
      const hexOctets = []; // new Array(buff.length) is even faster (preallocates necessary array size), then use hexOctets[i] instead of .push()

      for (let i = 0; i < buff.length; ++i)
	  hexOctets.push(byteToHex[buff[i]]);

      return hexOctets.join("");
  }


  async function computeHash(name, persona, context, date) {
      var salt = "salt salt salt. salt in my hash. hash hash hash, hash into my key";
      var keydata = new TextEncoder().encode(name);
      var key = await crypto.subtle.importKey("raw", keydata, "PBKDF2", false, ["deriveKey"])

      var hmac_key = await crypto.subtle.deriveKey({ name: 'PBKDF2', hash: 'SHA-256', salt: new TextEncoder().encode(salt), iterations: 310000}, key, { name: "HMAC", hash: "SHA-256" }, false, ["sign"]);
      
      var payload = [context, persona, date].join(",");
      var payloadData = new TextEncoder().encode(payload);

      var signature = await crypto.subtle.sign("HMAC", hmac_key, payloadData);
      var signature_str = hex(signature);
      return signature_str;
  }
  
  goButton.addEventListener("click", async () => {
     const hexdigestSize = 10;
     var signature_str = await computeHash(fullnameField.value, codenameField.value, jobsrcField.value, dateField.value);
      
    var hashOutput = signature_str.slice(0, hexdigestSize);
    outputDiv.innerText = codenameField.value + " (" + hashOutput + ", " + jobsrcField.value + ", " + dateField.value + ")";
    localStorage.setItem("codename", codenameField.value);
    localStorage.setItem("fullname", fullnameField.value);
  });


  verifyButton.addEventListener("click", async () => {
      var hashOutputList = [];
      var verifiedOutputList = [];

      var regexp = /([^\(]*) \((\w+), (\w+), (\d+)\)/;
      var personaStr = verifyField.value;
      var match = regexp.exec(personaStr);
      var persona = match[1];
      var hashToVerify = match[2];
      var context = match[3];
      var date = match[4];
      var name = providedNameField.value;

      var signature_str = await computeHash(name, persona, context, date);
      var hashOutput = signature_str.slice(0, 10);
     
      for ( var i = 0; i < 10; i++) {
         if ( hashOutput[i] == hashToVerify[i] ) {
           hashOutputList.push('<span style="background-color: lightgreen">' + hashOutput[i] + '</span>');
           verifiedOutputList.push('<span style="background-color: lightgreen">' + hashToVerify[i] + '</span>');
         }
         else {
           hashOutputList.push('<span style="background-color: lightcoral">' + hashOutput[i] + '</span>');
           verifiedOutputList.push('<span style="background-color: lightcoral">' + hashToVerify[i] + '</span>');
         }
      }
      hashToVerifyDiv.innerHTML = hashOutputList.join('') + ' ' + ((hashOutput == hashToVerify) ? '\u2705' : '\u274C');
      hashComputedDiv.innerHTML = verifiedOutputList.join('');
      
  });


</script>

</body>
</html>
